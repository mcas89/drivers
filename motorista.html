<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Motorista</title>

  <style>
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-title {
  font-size: 18px;
  display: flex;
  align-items: center;
}

.card-title i {
  margin-right: 10px;
}

.navegacao-buttons {
  display: inline-flex;
  align-items: center;
}

.navegacao-buttons div {
  margin-left: 15px;
  cursor: pointer;
}

.navegacao-buttons i {
  margin-right: 5px; /* Espa√ßo entre o √≠cone e o texto */
}

.navegar-passageiro,
.navegar-destino {
  font-size: 14px;
  color: #333;
}

.info-bloco {
  margin-top: 10px;
}

.info-linha {
  display: flex;
  align-items: center;
}

.info-linha i {
  margin-right: 5px; /* Espa√ßo entre √≠cone e o texto */
}

.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 350px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.modal-content h3 {
  margin-bottom: 10px;
  font-size: 1.2rem;
}

.modal-content input {
  width: 100%;
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

.modal-content button {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 6px;
  margin-top: 5px;
  cursor: pointer;
  background-color: #4CAF50;
  color: white;
}

.modal-content .cancelar {
  background-color: #e53935;
}


#painelMotorista {
  padding: 0;
  margin: 0;
}

.cardPainel {
  margin-top: 0px !important;
  padding-top: 0px !important;
}




#loadingIcon {
  font-size: 18px; /* Ajuste o tamanho do emoji */
  margin-left: 10px;
  display: inline-block;
  animation: spin 1s linear infinite; /* Anima√ß√£o de rota√ß√£o */
}

/* Definindo a anima√ß√£o de rota√ß√£o */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* Classe "hidden" para esconder o emoji quando n√£o estiver sendo usado */
.hidden {
  display: none;
}
.card-corrida {
  padding: 16px;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  text-align: center; /* <<< centraliza todo conte√∫do */
}
.card-title {
  margin-bottom: 16px;
  font-size: 20px;
  display: inline-flex; /* <<< importante para centralizar √≠cone + texto juntos */
  align-items: center;
  gap: 8px;
}

.info-bloco {
  margin-bottom: 12px;
}

.info-linha {
  display: inline-flex; /* <<< importante para alinhar na mesma linha centralizada */
  align-items: center;
  gap: 6px;
  justify-content: center; /* <<< centraliza dentro da linha */
}

.endereco-texto {
  margin: 4px 0 0 0;
  font-size: 14px;
  color: #333;
  word-break: break-word;
}

.icon-copy {
  font-size: 14px;
  color: #555;
  cursor: pointer;
  margin-left: 4px;
}

.icon-copy:hover {
  color: #000;
}

.info-valores {
  display: flex;
  justify-content: center;
  gap: 16px;
  align-items: center;
  margin-bottom: 16px;
}

.mapa-corrida {
  width: 100%;
  height: 300px;
  border-radius: 8px;
  overflow: hidden;
  background: #eee;
  margin-top: 16px;
}



.hidden {
  display: none;
}


.topoIcons {
  display: flex;
  justify-content: space-between; /* Coloca cada √≠cone numa ponta */
  align-items: center;
  padding: 10px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  margin-bottom: 10px;
}

.iconItem {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1; /* Cada √≠cone ocupa 1/3 do espa√ßo */
  cursor: pointer;
  color: #333; /* √çcones pretos */

  
}

.iconItem i {
  font-size: 18px;
  color: #333; /* √çcones pretos */
}

.iconItem span {
  margin-top: 0px;
  font-size: 0.8rem;
  color: #555;
}

.cardPainel {
  background: #ffffff;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  text-align: left;
}

.cardPainel h2 {
  font-size: 1.1rem;

  margin: 8px 0;
  color: #333;
}

.cardPainel p {
  font-size: 0.85rem;
  margin: 6px 0;
  color: #555;
}

.cardPainel i {
  margin-right: 5px;
  color: #333;
}

    /* ---------------------------------
      Estilo Geral
    ---------------------------------- */
    body {
      margin-top: 0;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #74ebd5, #ACB6E5);
      min-height: 100vh;
      display: flex;
      justify-content: flex-start; /* Ajustado para manter o conte√∫do mais alinhado ao topo */
      align-items: flex-start;
      padding-top: 20px;
      overflow-x: hidden;
    }
    
    
    .container {

      margin-top: 0;
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 360px;
      text-align: center;
      animation: fadeIn 0.6s ease;
    }
    
    /* ---------------------------------
      Inputs e Bot√µes gerais
    ---------------------------------- */
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      font-weight: 600;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #45a049;
      transform: scale(1.02);
    }
    
    /* ---------------------------------
      Cabe√ßalhos
    ---------------------------------- */
    h2, h3, h4 {
      text-align: center;
      margin-bottom: 10px;
    }
    
    /* ---------------------------------
      Carteira e Mapa
    ---------------------------------- */
    .carteira {
      background: #e9f5e9;
      padding: 10px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      color: #2e7d32;
      margin-top: 10px;
    }
    
    #mapaCorrida {
      height: 180px;
      border-radius: 12px;
      margin-top: 10px;
    }
    
    /* ---------------------------------
      Bot√£o Copiar
    ---------------------------------- */
    .btn-copy {
      background-color: #007bff;
      font-size: 12px;
      padding: 6px;
      margin-left: 5px;
      border-radius: 8px;
      color: white;
    }
    
    .btn-copy:hover {
      background-color: #0056b3;
    }
    
    /* ---------------------------------
      Cards normais
    ---------------------------------- */
    .card {
      background: #ffffff;
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
      border-radius: 16px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.08);
    }
    
    /* ---------------------------------
      Cards de Corrida
    ---------------------------------- */
    .card-corrida {
      background: #ffffff;
      border: 1px solid #ccc;
      padding: 8px 10px;
      margin: 6px 0;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      font-size: 12.5px;
      line-height: 1.05;
      animation: pulsar 2s infinite;
    }
    
    .card-corrida p, .card-corrida span {
      margin: 1px 0;
    }
    
    .card-corrida button {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      border-radius: 8px;
    }
    
    /* Linha Pre√ßo + Dist√¢ncia + Cr√©ditos */
    .linha-info {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 8px;
      gap: 16px;
      font-size: 12.5px;
    }
    
    .linha-info span {
      text-align: center;
    }
    
    /* BotoÃÉes Aceitar / Fechar */
    .botoes-corrida {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn-aceitar, .btn-fechar {
      flex: 1;
      padding: 6px;
      font-size: 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .btn-aceitar {
      background-color: #4CAF50;
      color: white;
      border: none;
    }
    
    .btn-aceitar:hover {
      background-color: #45a049;
    }
    
    .btn-fechar {
      background-color: #e53935;
      color: white;
      border: none;
    }
    
    .btn-fechar:hover {
      background-color: #d32f2f;
    }
    
    /*---------------------------------
    login
    ----------------------------------*/
    *, *::before, *::after {
      box-sizing: border-box;
    }
    

    h2 {
      margin-bottom: 1.5rem;
      color: #333;
    }
    
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: #74ebd5;
      outline: none;
    }
    
    button {
      width: 100%;
      padding: 0.8rem;
      background-color: #74ebd5;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #58c5c2;
    }
    
    p {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #555;
    }
    
    a {
      color: #74ebd5;
      text-decoration: none;
      font-weight: bold;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    .hidden {
      display: none;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ---------------------------------
    Responsivo
    ---------------------------------- */
    @media (max-width: 600px) {
      body {
        padding-top: 10px;
      }
    
      .container {
      
        padding: 15px;
        margin: 5px;
      }
    
      h2 {
        font-size: 1.5rem;
      }
    
      input, button {
        font-size: 13px;
      }
    
      .btn-copy {
        font-size: 10px;
      }
    
      .carteira {
        font-size: 14px;
      }
    
      .card-corrida {
        font-size: 12px;
        padding: 10px;
        margin: 8px 0;
      }
    
      button {
        font-size: 13px;
        padding: 12px;
      }
    }
    
    @keyframes pulsar {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
    
      </style>
    
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

</head>

<body>
  <div class="container" id="loginContainer">
    <h2><i class="fas fa-user-shield"></i> Login Motorista</h2>
    <input type="text" id="cpf" placeholder="CPF">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="loginMotorista()">
      <i class="fas fa-sign-in-alt"></i> Entrar
    </button>
    <p>N√£o tem cadastro? <a href="#" onclick="mostrarCadastro()">Cadastre-se</a></p>
  </div>

  <div class="container hidden" id="cadastroContainer">
    <h2><i class="fas fa-id-card"></i> Cadastro Motorista</h2>
    <input type="text" id="nomeCadastro" placeholder="Nome">
    <input type="text" id="cpfCadastro" placeholder="CPF">
    <input type="password" id="senhaCadastro" placeholder="Senha">
    <input type="text" id="telefoneCadastro" placeholder="Telefone">
    <input type="text" id="modeloCadastro" placeholder="Modelo do Ve√≠culo">
    <input type="text" id="placaCadastro" placeholder="Placa">
    <button onclick="cadastrarMotorista()">
      <i class="fas fa-user-plus"></i> Cadastrar
    </button>
    <p><a href="#" onclick="mostrarLogin()">J√° tem conta? Entrar</a></p>
  </div>

  <div class="container" id="painelMotorista">

      <div class="container" id="painelMotorista">


      <!-- Linha de √≠cones no topo -->
      <div class="topoIcons">
        <div class="iconItem">
          <i class="fas fa-star"></i>
          <span id="creditosMotorista" style="font-size: 0.8rem;">0</span>
        </div>
    
        <div class="iconItem" onclick="editarDadosMotorista()">
          <i class="fas fa-pen"></i>
          <span class="iconText">Editar</span>
        </div>
        
    
        <div class="iconItem" onclick="logoutMotorista()">
          <i class="fas fa-sign-out-alt"></i>
          <span class="iconText">Logof</span>
        </div>
      </div>
    
      <!-- Informa√ß√µes do motorista -->
      <div class="cardPainel">
        <h2><i class="fas fa-user"></i> <span id="nomeMotorista"></span></h2>
        <p><i class="fas fa-phone"></i> <span id="telefoneMotorista"></span></p>
        <p><i class="fas fa-car-side"></i> <span id="modeloMotorista"></span> - <span id="placaMotorista"></span></p>
      </div>
    
    </div>
    
  

    <h3 id="corridasDisponiveis">
      <i class="fas fa-taxi"></i> Corridas Dispon√≠veis
      <span id="loadingIcon" class="hidden">‚Üª</span> <!-- Emoji de ampulheta -->
    </h3>



    <div id="corridasContainer"></div>

    <div id="corridaAceitaCard" class="card hidden card-corrida">
      <div class="card-header">
        <h4 class="card-title" style="display: flex; align-items: center; justify-content: center; width: 100%; margin: 0;">
          <i class="fas fa-check-circle icon-green" style="margin-right: 8px;"></i>
          Corrida Aceita
        </h4>
      </div>
    
    
      <!-- Bloco de partida -->
      <div class="info-bloco">
        <div class="info-linha">
          <i class="fas fa-map-marker-alt icon-red"></i> 
          <strong>Partida:</strong>
          <i class="fas fa-copy icon-copy" onclick="copiarTexto('endPartida')" style="margin-left: 10px; font-size: 16px;"></i>
          <i class="fas fa-location-arrow icon-blue" onclick="navegarPassageiro()" style="margin-left: 10px; cursor: pointer; font-size: 16px;"></i>
        </div>
        <p id="endPartida" class="endereco-texto"></p>
      </div>
    
      <!-- Bloco de destino -->
      <div class="info-bloco">
        <div class="info-linha">
          <i class="fas fa-map-pin icon-blue"></i> 
          <strong>Destino:</strong>
          <i class="fas fa-copy icon-copy" onclick="copiarTexto('endDestino')" style="margin-left: 10px; font-size: 16px;"></i>
          <i class="fas fa-location-arrow icon-blue" onclick="navegarDestino()" style="margin-left: 10px; cursor: pointer; font-size: 16px;"></i>
        </div>
        <p id="endDestino" class="endereco-texto"></p>
      </div>
    
      <!-- Bloco de valores -->
      <div class="info-valores">
        <p>
          <i class="fas fa-coins icon-gold"></i> 
          <strong>Valor:</strong> <span id="valorCorrida"></span>
        </p>
        <p>
          <i class="fas fa-road icon-gray"></i> 
          <strong>Dist√¢ncia:</strong> <span id="distanciaAceita"></span> km
        </p>
      </div>
    
      <!-- Mapa -->
      <div id="mapaCorrida" class="mapa-corrida"></div>
    </div>
    
    
    </div>

    </div>
  </div>


  <div id="editarModal" class="modal hidden">
    <div class="modal-content">
      <h3>Editar Dados</h3>
      <label>Nome:</label>
      <input type="text" id="editarNome">
  
      <label>Telefone:</label>
      <input type="text" id="editarTelefone">
  
      <label>Modelo:</label>
      <input type="text" id="editarModelo">
  
      <label>Placa:</label>
      <input type="text" id="editarPlaca">
  
      <button onclick="salvarEdicao()">Salvar</button>
      <button onclick="fecharModal()" class="cancelar">Cancelar</button>
    </div>
  </div>
  
</body>

  <script>
    const baseURL = 'https://cardosoborracharia-a8854-default-rtdb.firebaseio.com';
    const geoapifyKey = '6d5858a5a2b143618a05523338f5a0aa';
    let motoristaCPF = '';
    let motoristaCreditos = 0;
    let rotaAtual = null;
    let cancelamentoPermitido = true;
    let mapaCorrida;
    let wakeLock = null;
    let timestampAceitacao = null;
    let podeCancelarComCredito = true;

    window.onload = () => {
      solicitarWakeLock()
      document.getElementById('painelMotorista').classList.add('hidden');
  const motoristaSalvo = localStorage.getItem('motoristaLogado');
  if (motoristaSalvo) {
    motoristaCPF = motoristaSalvo;
    fetch(`${baseURL}/motoristas/${motoristaCPF}.json`)
      .then(res => res.json())
      .then(data => {
        if (data) {
          motoristaCreditos = data.creditos || 0;
          document.getElementById('nomeMotorista').textContent = data.nome;
          document.getElementById('telefoneMotorista').textContent = data.telefone;
          document.getElementById('modeloMotorista').textContent = data.modelo;
          document.getElementById('placaMotorista').textContent = data.placa;
          document.getElementById('creditosMotorista').textContent = motoristaCreditos;

          document.getElementById('loginContainer').classList.add('hidden');
          document.getElementById('painelMotorista').classList.remove('hidden');
                    buscarCorridaAceita();

          carregarCorridas();
          setInterval(carregarCorridas, 5000);
        }
      });
  }
}

    function logoutMotorista() {
      localStorage.removeItem('motoristaLogado');
      location.reload(); // Atualiza a p√°gina e volta pro login
      document.getElementById('cardPainel').classList.remove('hidden');
      document.getElementById('painelMotorista').classList.remove('hidden');
      
    }

    async function solicitarWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('Tela mantida ativa.');
      } catch (err) {
        console.error('N√£o foi poss√≠vel manter a tela ativa:', err);
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        solicitarWakeLock();
      }
    });

    function buscarCorridaAceita() {
  fetch(`${baseURL}/corridas.json`)
    .then(res => res.json())
    .then(data => {
      if (!data) return;

      for (const id in data) {
        const corrida = data[id];
        if (corrida.motorista === motoristaCPF && corrida.status === 'aceita') {
          rotaAtual = id;

          document.getElementById('endPartida').textContent = corrida.partida;
          document.getElementById('endDestino').textContent = corrida.destino;
          document.getElementById('valorCorrida').textContent = `R$ ${corrida.preco.toFixed(2)}`;
          document.getElementById('distanciaAceita').textContent = corrida.distancia_km.toFixed(2);

          document.getElementById('corridaAceitaCard').classList.remove('hidden');

          mostrarMapa(corrida.partida, corrida.destino);

          // üîµ Criar o bot√£o de Cancelar (se n√£o existir)
          const card = document.getElementById('corridaAceitaCard');
          let btnCancelar = document.getElementById('btnCancelarTemp');
          if (!btnCancelar) {
            btnCancelar = document.createElement('button');
            btnCancelar.id = 'btnCancelarTemp';
            btnCancelar.style.marginTop = '10px';
            btnCancelar.style.backgroundColor = 'red';
            btnCancelar.style.color = 'white';
            btnCancelar.style.borderRadius = '8px';
            btnCancelar.style.padding = '10px';
            btnCancelar.textContent = 'Cancelar Corrida';
            btnCancelar.onclick = () => cancelarCorrida(id, calcularCreditosPorValor(corrida.preco));
            card.appendChild(btnCancelar);
          }

          // üïë Salvar o momento da aceita√ß√£o
          timestampAceitacao = Date.now();

          // üîµ Buscar dados do passageiro
          fetch(`${baseURL}/passageiros/${id}.json`)
            .then(res => res.json())
            .then(passageiro => {
              if (passageiro) {
                const infoPassageiro = document.createElement('div');
                infoPassageiro.innerHTML = `
                  <p><strong>Passageiro:</strong> ${passageiro.nome}</p>
                  <p><strong>Telefone:</strong> ${passageiro.telefone}</p>
                `;
                card.appendChild(infoPassageiro);
              }
            })
            .catch(error => {
              console.error('Erro ao buscar dados do passageiro:', error);
            });

          break; // achou, pode parar
        }
      }
    })
    .catch(error => {
      console.error('Erro ao buscar corrida aceita:', error);
    });
}

    function finalizarCancelamento(mensagem) {
      alert(mensagem);
      document.getElementById('corridaAceitaCard').classList.add('hidden');
      rotaAtual = null;
      document.getElementById('corridasContainer').style.display = 'block';
      document.querySelector('h3 i.fa-taxi').parentElement.style.display = 'block';
      carregarCorridas();
    }

    function cancelarCorrida(id) {
      if (!id) return;

      // Busca a corrida para saber quantos cr√©ditos foram usados
      fetch(`${baseURL}/corridas/${id}.json`)
        .then(res => res.json())
        .then(corrida => {
          if (!corrida) return;

          const creditosUsados = corrida.creditosUsados || 0;

          const atualizacoes = {
            [`corridas/${id}/status`]: 'pendente',
            [`corridas/${id}/motorista`]: null
          };

          if (podeCancelarComCredito) {
            fetch(`${baseURL}/motoristas/${motoristaCPF}/creditos.json`)
              .then(res => res.json())
              .then(creditosAtuais => {
                const novosCreditos = (creditosAtuais || 0) + creditosUsados;
                atualizacoes[`motoristas/${motoristaCPF}/creditos`] = novosCreditos;

                fetch(`${baseURL}/.json`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(atualizacoes)
                }).then(() => {
                  motoristaCreditos = novosCreditos;
                  document.getElementById('creditosMotorista').textContent = novosCreditos;
                  finalizarCancelamento('Corrida cancelada. Cr√©ditos devolvidos.');
                });
              });
          } else {
            fetch(`${baseURL}/.json`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(atualizacoes)
            }).then(() => {
              finalizarCancelamento('Corrida cancelada ap√≥s 10s. Cr√©ditos n√£o devolvidos.');
            });
          }
        })
        .catch(error => {
          console.error('Erro ao cancelar corrida:', error);
          alert('Erro ao cancelar a corrida. Tente novamente.');
        });
    }

    function mostrarCadastro() {
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('cadastroContainer').classList.remove('hidden');
    }

    function mostrarLogin() {
      document.getElementById('cadastroContainer').classList.add('hidden');
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('painelMotorista').classList.add('hidden');

    }

    async function cadastrarMotorista() {
  const nome = document.getElementById('nomeCadastro').value.trim();
  const cpf = document.getElementById('cpfCadastro').value.trim();
  const senha = document.getElementById('senhaCadastro').value.trim();
  const telefone = document.getElementById('telefoneCadastro').value.trim();
  const modelo = document.getElementById('modeloCadastro').value.trim();
  const placa = document.getElementById('placaCadastro').value.trim();

  // Valida√ß√£o simples
  if (!nome || !cpf || !senha || !telefone || !modelo || !placa) {
    alert('Por favor, preencha todos os campos.');
    return;
  }

  // Valida√ß√£o de CPF
  if (!validarCPF(cpf)) {
    alert('CPF inv√°lido. Por favor, digite um CPF v√°lido.');
    return;
  }

  try {
    // Verifica se o CPF j√° est√° cadastrado
    const res = await fetch(`${baseURL}/motoristas/${cpf}.json`);
    if (!res.ok) throw new Error('Erro ao verificar CPF.');

    const data = await res.json();
    if (data) {
      alert('J√° existe um motorista cadastrado com este CPF.');
      return;
    }

    // Cadastra o novo motorista
    const response = await fetch(`${baseURL}/motoristas/${cpf}.json`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nome, senha, telefone, modelo, placa, creditos: 0 })
    });

    if (!response.ok) throw new Error('Erro ao cadastrar motorista');

    alert('Cadastro realizado com sucesso!');
    
    // Oculta o painel do motorista e mostra o login ap√≥s o cadastro
    document.getElementById('painelMotorista').classList.add('hidden');
    mostrarLogin();  // Chama a fun√ß√£o para exibir a tela de login

  } catch (error) {
    console.error(error);
    alert('Erro ao cadastrar. Tente novamente.');
  }
}

    function sairParaLogin() {
      // Oculta o painel do motorista ao sair do cadastro
      document.getElementById('painelMotorista').classList.add('hidden');
      
      // Chama a fun√ß√£o que exibe a tela de login
      mostrarLogin();
    }

    function loginMotorista() {

      const cpf = document.getElementById('cpf').value;
      const senha = document.getElementById('senha').value;

      fetch(`${baseURL}/motoristas/${cpf}.json`)
        .then(res => res.json())
        .then(data => {
          if (!data || data.senha !== senha) return alert('CPF ou senha incorretos');

          motoristaCPF = cpf;
          motoristaCreditos = data.creditos || 0;

          document.getElementById('nomeMotorista').textContent = data.nome;
          document.getElementById('telefoneMotorista').textContent = data.telefone;
          document.getElementById('modeloMotorista').textContent = data.modelo;
          document.getElementById('placaMotorista').textContent = data.placa;
          document.getElementById('creditosMotorista').textContent = motoristaCreditos;

          document.getElementById('loginContainer').classList.add('hidden');
          document.getElementById('painelMotorista').classList.remove('hidden');
          
          

          localStorage.setItem('motoristaLogado', cpf);
          solicitarWakeLock()
          buscarCorridaAceita();



          carregarCorridas();
          setInterval(carregarCorridas, 5000);
        });
    }

    function calcularCreditosPorValor(preco) {
      if (preco <= 10) return 1;
      if (preco <= 15) return 2;
      if (preco <= 20) return 3;
      if (preco <= 25) return 4;
      if (preco <= 30) return 5;
      return 6;
    }

    function carregarCorridas() {
  fetch(`${baseURL}/corridas.json`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('corridasContainer');
      container.innerHTML = '';

      for (const id in data) {
        const corrida = data[id];
        if (corrida.status === 'pendente' || corrida.status === 'cancelado') {
          const creditosNecessarios = calcularCreditosPorValor(corrida.preco);

          const card = document.createElement('div');
        card.className = 'card-corrida';
        card.id = `card-${id}`; // cada card com um ID √∫nico!

        card.innerHTML = `
          <p><i class="fas fa-map-marker-alt"></i> <strong>Partida:</strong><br>${corrida.partida}</p>
          <p><i class="fas fa-map-pin"></i> <strong>Destino:</strong><br>${corrida.destino}</p>

          <div class="linha-info">
            <span><i class="fas fa-road"></i> ${corrida.distancia_km.toFixed(2)} km</span>
            <span><i class="fas fa-coins"></i> R$ ${corrida.preco.toFixed(2)}</span>
            <span><i class="fas fa-star"></i> ${creditosNecessarios} cr√©ditos</span>
          </div>

          <div class="botoes-corrida">
            <button class="btn-aceitar" onclick="aceitarCorrida('${id}', ${creditosNecessarios}, '${corrida.partida}', '${corrida.destino}', ${corrida.preco}, ${corrida.distancia_km})">

              <i class="fas fa-check"></i> Aceitar
            </button>
            <button class="btn-fechar" onclick="fecharCorrida('${id}')">
              <i class="fas fa-times"></i> Fechar
            </button>
          </div>
        `;
        container.appendChild(card);




        }
      }
    });
}

function aceitarCorrida(id, creditosNecessarios, partida, destino, preco, distancia_km) {
    if (motoristaCreditos < creditosNecessarios) {
        mostrarAlertaSimples('Cr√©ditos insuficientes para aceitar esta corrida.');
        return;
    }

    fetch(`${baseURL}/corridas/${id}.json`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            status: 'aceita',
            motorista: motoristaCPF,
            preco: preco,
            distancia_km: distancia_km,
            creditosUsados: creditosNecessarios
        })
    }).then(() => {
        motoristaCreditos -= creditosNecessarios;
        document.getElementById('creditosMotorista').textContent = motoristaCreditos;

        fetch(`${baseURL}/motoristas/${motoristaCPF}.json`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ creditos: motoristaCreditos })
        });

        document.getElementById('endPartida').textContent = partida;
        document.getElementById('endDestino').textContent = destino;
        document.getElementById('valorCorrida').textContent = `R$ ${preco.toFixed(2)}`;
        document.getElementById('distanciaAceita').textContent = distancia_km.toFixed(2);

        const card = document.getElementById('corridaAceitaCard');
        
        // Limpar dados antigos do passageiro assim que o card for aberto
        const antigoPassageiro = card.querySelector('.info-passageiro');
        if (antigoPassageiro) {
            antigoPassageiro.remove();
        }

        // Mostrar o card de corrida aceita
        card.classList.remove('hidden');

        // Esconder os √≠cones de corridas dispon√≠veis
        document.querySelector('h3 i.fa-taxi').parentElement.style.display = 'none';
        document.getElementById('corridasContainer').style.display = 'none';

        // Remover o card antigo da corrida, se houver
        const cardAceito = document.getElementById(`card-${id}`);
        if (cardAceito) {
            cardAceito.remove();
        }

        // Atualizar a vari√°vel da rota atual
        rotaAtual = id;
        mostrarMapa(partida, destino);

        // Cria√ß√£o do bot√£o cancelar
        const btnExistente = document.getElementById('btnCancelarTemp');
        if (btnExistente) btnExistente.remove();

        let btnCancelar = document.createElement('button');
        btnCancelar.id = 'btnCancelarTemp';
        btnCancelar.style.marginTop = '10px';
        btnCancelar.style.backgroundColor = 'red';
        btnCancelar.style.color = 'white';
        btnCancelar.style.borderRadius = '8px';
        btnCancelar.style.padding = '10px';
        btnCancelar.textContent = 'Cancelar Corrida (10s)';
        btnCancelar.onclick = () => cancelarCorrida(id);

        card.appendChild(btnCancelar);  // Adiciona o bot√£o de cancelar no card

        // ‚è±Ô∏è In√≠cio do temporizador de cancelamento com cr√©dito
        let segundos = 10;
        podeCancelarComCredito = true;

        const interval = setInterval(() => {
            segundos--;
            btnCancelar.textContent = segundos > 0 ? `Cancelar Corrida (${segundos}s)` : 'Cancelar Corrida';

            if (segundos === 0) {
                clearInterval(interval);
                podeCancelarComCredito = false;

                // Mostrar dados do passageiro
                fetch(`${baseURL}/passageiros/${id}.json`)
                    .then(res => res.json())
                    .then(passageiro => {
                        if (passageiro) {
                            const infoPassageiro = document.createElement('div');
                            infoPassageiro.classList.add('info-passageiro');
                            infoPassageiro.innerHTML = `
                                <p><strong>Passageiro:</strong> ${passageiro.nome}</p>
                                <p><strong>Telefone:</strong> ${passageiro.telefone}</p>
                            `;
                            card.appendChild(infoPassageiro);
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar dados do passageiro:', error);
                    });
            }
        }, 1000);

        // üëÅÔ∏è Iniciar monitoramento da corrida
        monitorarCorridaAceita(id, motoristaCPF);

    }).catch(error => {
        console.error('Erro ao aceitar a corrida:', error);
        alert('Erro ao aceitar a corrida. Tente novamente.');
    });
}

    function copiarTexto(id) {
      const texto = document.getElementById(id).textContent;
      navigator.clipboard.writeText(texto);
      alert('Copiado: ' + texto);
    }

    async function mostrarMapa(partida, destino) {
      const coords = await Promise.all([
        getCoords(partida),
        getCoords(destino)
      ]);

      if (!coords[0] || !coords[1]) return;

      if (mapaCorrida) {
        mapaCorrida.remove();
      }
      mapaCorrida = L.map('mapaCorrida').setView(coords[0], 13);

      // Tile Layer mais bonito da Geoapify
      L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-carto/{z}/{x}/{y}.png?apiKey=${geoapifyKey}`, {
        attribution: '¬© OpenMapTiles ¬© OpenStreetMap contributors',
        maxZoom: 20
      }).addTo(mapaCorrida);

      // √çcones personalizados
      const iconeA = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });

      const iconeB = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });

      L.marker(coords[0], { icon: iconeA }).addTo(mapaCorrida).bindPopup("Partida").openPopup();
      L.marker(coords[1], { icon: iconeB }).addTo(mapaCorrida).bindPopup("Destino");

      const routeRes = await fetch(`https://api.geoapify.com/v1/routing?waypoints=${coords[0][1]},${coords[0][0]}|${coords[1][1]},${coords[1][0]}&mode=drive&apiKey=${geoapifyKey}`);
      const routeData = await routeRes.json();

      if (!routeData.features || routeData.features.length === 0) return alert('N√£o foi poss√≠vel tra√ßar a rota.');

      const rotaCoords = routeData.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      L.polyline(rotaCoords, { color: 'blue', weight: 5 }).addTo(mapaCorrida);

      mapaCorrida.fitBounds(rotaCoords, { padding: [50, 50] });

      document.getElementById('distanciaAceita').textContent = (routeData.features[0].properties.distance / 1000).toFixed(2);
      document.getElementById('duracaoAceita').textContent = (routeData.features[0].properties.time / 60).toFixed(1);
    }

    async function getCoords(endereco) {
      const res = await fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(endereco)}&apiKey=${geoapifyKey}`);
      const data = await res.json();
      if (!data.features || data.features.length === 0) {
        alert('Endere√ßo n√£o encontrado: ' + endereco);
        return null;
      }
      return [data.features[0].geometry.coordinates[1], data.features[0].geometry.coordinates[0]];
    }

    async function mostrarMapa(partida, destino) {
      const coords = await Promise.all([
        getCoords(partida),
        getCoords(destino)
      ]);

      if (!coords[0] || !coords[1]) return;

      if (mapaCorrida) {
        mapaCorrida.remove();
      }
      mapaCorrida = L.map('mapaCorrida').setView(coords[0], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapaCorrida);
      L.marker(coords[0]).addTo(mapaCorrida).bindPopup("Partida").openPopup();
      L.marker(coords[1]).addTo(mapaCorrida).bindPopup("Destino");

      fetch(`https://api.geoapify.com/v1/routing?waypoints=${coords[0][1]},${coords[0][0]}|${coords[1][1]},${coords[1][0]}&mode=drive&apiKey=${geoapifyKey}`)
        .then(res => res.json())
        .then(data => {
          if (!data.features || data.features.length === 0) return alert('N√£o foi poss√≠vel tra√ßar a rota.');

          const rota = data.features[0];
          const rotaCoords = rota.geometry.coordinates.map(c => [c[1], c[0]]);
          L.polyline(rotaCoords, { color: 'blue' }).addTo(mapaCorrida);
          mapaCorrida.fitBounds(rotaCoords);

          document.getElementById('distanciaAceita').textContent = (rota.properties.distance / 1000).toFixed(2);
          document.getElementById('duracaoAceita').textContent = (rota.properties.time / 60).toFixed(1);
        })
        .catch(() => alert('Erro ao buscar rota. Verifique os endere√ßos.'));
    }

    function fecharCorrida(id) {
      const card = document.getElementById(`card-${id}`);
      if (card) {
        card.remove();
      }
    }

    function monitorarCorridaAceita(idCorrida, cpfMotorista) {
  const interval = setInterval(() => {
    fetch(`${baseURL}/corridas/${idCorrida}.json`)
      .then(res => res.json())
      .then(corrida => {
        // Se a corrida sumiu completamente (deletada do banco)
        if (!corrida) {
          clearInterval(interval);
          alert('Corrida foi removida do sistema.');
          document.getElementById('corridaAceitaCard').classList.add('hidden');
          document.querySelector('h3 i.fa-taxi').parentElement.style.display = 'block';
          carregarCorridas();
          return;
        }

        // Se a corrida foi cancelada por outro (n√£o √© mais "aceita")
        if (corrida.status !== 'aceita' || corrida.motorista !== cpfMotorista) {
          clearInterval(interval);
          alert('Corrida n√£o est√° mais dispon√≠vel.');
          document.getElementById('corridaAceitaCard').classList.add('hidden');
          document.querySelector('h3 i.fa-taxi').parentElement.style.display = 'block';
          carregarCorridas();
          return;
        }
      })
      .catch(error => {
        console.error('Erro ao monitorar corrida:', error);
        clearInterval(interval);
      });
  }, 3000);
}

    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, ''); // Remove n√£o n√∫meros

      if (cpf.length !== 11) return false;
      if (/^(\d)\1+$/.test(cpf)) return false; // Ex: 111.111.111-11

      let soma = 0;
      for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
      }
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
      }
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(10))) return false;

      return true;
    }

    function mostrarAlertaSimples(mensagem) {
    // Evita criar v√°rios alertas empilhados
    if (document.getElementById('alerta-simples')) return;

    const alerta = document.createElement('div');
    alerta.id = 'alerta-simples';
    alerta.style.position = 'fixed';
    alerta.style.top = '20px';
    alerta.style.left = '50%';
    alerta.style.transform = 'translateX(-50%)';
    alerta.style.backgroundColor = '#ff4d4d'; // vermelho mais bonito
    alerta.style.color = '#fff';
    alerta.style.padding = '12px 20px';
    alerta.style.borderRadius = '8px';
    alerta.style.textAlign = 'center';
    alerta.style.zIndex = '1000';
    alerta.style.fontSize = '16px';
    alerta.style.fontFamily = 'Arial, sans-serif';
    alerta.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
    alerta.style.opacity = '0';
    alerta.style.transition = 'opacity 0.5s ease';

    alerta.innerText = mensagem;
    document.body.appendChild(alerta);

    // Deixa o alerta vis√≠vel com transi√ß√£o
    setTimeout(() => {
        alerta.style.opacity = '1';
    }, 50);

    // Some depois de 4 segundos
    setTimeout(() => {
        alerta.style.opacity = '0';
        setTimeout(() => {
            alerta.remove();
        }, 500); // Espera a transi√ß√£o terminar antes de remover
    }, 4000);
}

function editarDadosMotorista() {
  fetch(`${baseURL}/motoristas/${motoristaCPF}.json`)
    .then(res => res.json())
    .then(data => {
      if (data) {
        document.getElementById('editarNome').value = data.nome || '';
        document.getElementById('editarTelefone').value = data.telefone || '';
        document.getElementById('editarModelo').value = data.modelo || '';
        document.getElementById('editarPlaca').value = data.placa || '';

        document.getElementById('editarModal').classList.remove('hidden');
      }
    });
}

function fecharModal() {
  document.getElementById('editarModal').classList.add('hidden');
}

function salvarEdicao() {
  const novoNome = document.getElementById('editarNome').value.trim();
  const novoTel = document.getElementById('editarTelefone').value.trim();
  const novoModelo = document.getElementById('editarModelo').value.trim();
  const novaPlaca = document.getElementById('editarPlaca').value.trim();

  const atualizados = {
    nome: novoNome,
    telefone: novoTel,
    modelo: novoModelo,
    placa: novaPlaca
  };

  fetch(`${baseURL}/motoristas/${motoristaCPF}.json`, {
    method: 'PATCH',
    body: JSON.stringify(atualizados)
  })
  .then(res => res.json())
  .then(() => {
    // Atualiza na interface
    document.getElementById('nomeMotorista').textContent = novoNome;
    document.getElementById('telefoneMotorista').textContent = novoTel;
    document.getElementById('modeloMotorista').textContent = novoModelo;
    document.getElementById('placaMotorista').textContent = novaPlaca;

    fecharModal();
    alert("Dados atualizados com sucesso!");
  })
  .catch(err => {
    console.error("Erro ao salvar edi√ß√£o:", err);
    alert("Erro ao salvar os dados.");
  });
}

// Fun√ß√£o para obter a localiza√ß√£o atual do motorista
function obterLocalizacaoAtual(callback) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const localizacaoAtual = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            callback(localizacaoAtual); // Retorna a localiza√ß√£o atual para a fun√ß√£o de callback
        }, function() {
            alert("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
        });
    } else {
        alert("Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.");
    }
}

// Fun√ß√£o para navegar at√© o Passageiro
function navegarPassageiro() {
    obterLocalizacaoAtual(function(localizacaoAtual) {
        const partida = document.getElementById('endPartida').textContent; // Endere√ßo de partida do passageiro
        if (partida) {
            const enderecoPartida = encodeURIComponent(partida); // Codifica o endere√ßo para a URL
            // Cria a URL do Google Maps com a localiza√ß√£o atual e o endere√ßo de partida
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${localizacaoAtual.lat},${localizacaoAtual.lng}&destination=${enderecoPartida}`;
            window.open(googleMapsUrl, '_blank'); // Abre o Google Maps em uma nova aba
        } else {
            alert('Endere√ßo de partida n√£o encontrado!');
        }
    });
}

// Fun√ß√£o para navegar at√© o Destino
function navegarDestino() {
    obterLocalizacaoAtual(function(localizacaoAtual) {
        const destino = document.getElementById('endDestino').textContent; // Endere√ßo de destino do passageiro
        if (destino) {
            const enderecoDestino = encodeURIComponent(destino); // Codifica o endere√ßo para a URL
            // Cria a URL do Google Maps com a localiza√ß√£o atual e o endere√ßo de destino
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${localizacaoAtual.lat},${localizacaoAtual.lng}&destination=${enderecoDestino}`;
            window.open(googleMapsUrl, '_blank'); // Abre o Google Maps em uma nova aba
        } else {
            alert('Endere√ßo de destino n√£o encontrado!');
        }
    });
}


  </script>
</body>
</html>